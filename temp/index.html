<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Image Resizer & Converter</title>
  <!-- Load Tailwind CSS from CDN for a modern, responsive design -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Use Inter font for a clean, modern look -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      /* Dark background for a sleek, modern feel */
      background-color: #1a202c;
      transition: background-color 0.3s ease;
    }
    .container {
      /* Soft shadows and subtle borders for depth */
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    .file-input-label {
      background-color: #2d3748;
      border: 2px dashed #4a5568;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .file-input-label:hover {
      background-color: #4a5568;
      border-color: #63b3ed;
    }
    .input-field {
      background-color: #2d3748;
      color: #e2e8f0;
      border: 1px solid #4a5568;
      transition: border-color 0.2s ease;
    }
    .input-field:focus {
      border-color: #63b3ed;
      outline: none;
    }
    .btn-primary {
      background-color: #4299e1;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .btn-primary:hover {
      background-color: #3182ce;
      transform: translateY(-2px);
    }
    .btn-secondary {
      background-color: #48bb78;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .btn-secondary:hover {
      background-color: #38a169;
      transform: translateY(-2px);
    }
    .info-card {
      border-color: #4a5568;
      background-color: #2d3748;
      transition: box-shadow 0.3s ease;
    }
    .info-card:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    }
  </style>
</head>
<body class="flex items-center justify-center p-4 min-h-screen">
  <!-- Main container with a dark background and rounded corners -->
  <div class="container bg-gray-800 p-6 md:p-10 rounded-3xl w-full max-w-2xl text-gray-200">
    <h1 class="text-3xl md:text-4xl font-bold text-center text-white mb-6">Image Resizer & Converter</h1>

    <!-- File upload section with a drag-and-drop styled label -->
    <div class="mb-6">
      <label for="upload" id="file-drop-area" class="file-input-label flex flex-col items-center justify-center p-8 rounded-2xl cursor-pointer text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
        </svg>
        <span class="text-gray-400 font-semibold">Drag & Drop or <span class="text-blue-400">Click to Upload</span></span>
        <input type="file" id="upload" accept="image/*" class="hidden">
      </label>
    </div>
    
    <!-- Controls section grouped in a responsive grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Resize Mode dropdown -->
      <div>
        <label for="resizeMode" class="block text-gray-400 font-semibold mb-2">Resize Mode</label>
        <select id="resizeMode" class="input-field w-full p-3 rounded-xl focus:ring-2 focus:ring-blue-500">
          <option value="scale">Scale (%)</option>
          <option value="pixels">Dimensions (px)</option>
          <option value="dpi">Physical Size + DPI</option>
        </select>
      </div>
      <!-- Output Format dropdown -->
      <div>
        <label for="format" class="block text-gray-400 font-semibold mb-2">Output Format</label>
        <select id="format" class="input-field w-full p-3 rounded-xl focus:ring-2 focus:ring-blue-500">
          <option value="image/jpeg">JPEG</option>
          <option value="image/png">PNG</option>
          <option value="image/webp">WEBP</option>
        </select>
      </div>
    </div>
    
    <!-- Dynamic input boxes for different resize modes -->
    <div id="dynamicInputs" class="space-y-4 mb-6">
      <!-- Scale input -->
      <div id="scaleBox">
        <label for="scale" class="block text-gray-400 font-semibold mb-2">Scale (%)</label>
        <input type="number" id="scale" value="100" min="1" max="500" class="input-field w-full p-3 rounded-xl">
      </div>
      <!-- Pixel input (initially hidden) -->
      <div id="pixelBox" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="width" class="block text-gray-400 font-semibold mb-2">Width (px)</label>
          <input type="number" id="width" min="1" class="input-field w-full p-3 rounded-xl">
        </div>
        <div>
          <label for="height" class="block text-gray-400 font-semibold mb-2">Height (px)</label>
          <input type="number" id="height" min="1" class="input-field w-full p-3 rounded-xl">
        </div>
      </div>
      <!-- DPI input (initially hidden) -->
      <div id="dpiBox" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label for="cmWidth" class="block text-gray-400 font-semibold mb-2">Width (cm)</label>
          <input type="number" id="cmWidth" min="0.1" step="0.1" class="input-field w-full p-3 rounded-xl">
        </div>
        <div>
          <label for="cmHeight" class="block text-gray-400 font-semibold mb-2">Height (cm)</label>
          <input type="number" id="cmHeight" min="0.1" step="0.1" class="input-field w-full p-3 rounded-xl">
        </div>
        <div>
          <label for="dpi" class="block text-gray-400 font-semibold mb-2">DPI</label>
          <input type="number" id="dpi" value="300" min="1" class="input-field w-full p-3 rounded-xl">
        </div>
      </div>
    </div>
    
    <!-- Max file size input -->
    <div class="mb-6">
      <label for="maxSize" class="block text-gray-400 font-semibold mb-2">Max File Size (KB)</label>
      <input type="number" id="maxSize" value="300" min="1" class="input-field w-full p-3 rounded-xl">
    </div>

    <!-- Buttons section -->
    <div class="flex flex-col md:flex-row gap-4 mb-6">
      <button onclick="processImage()" id="processBtn" class="btn-primary w-full text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform hover:scale-105">
        <div class="flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
          </svg>
          <span>Apply & Preview</span>
        </div>
      </button>
      <a id="download" class="hidden w-full">
        <button class="btn-secondary w-full text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform hover:scale-105">
          <div class="flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
            <span>Download Image</span>
          </div>
        </button>
      </a>
    </div>

    <!-- Result information and preview canvas -->
    <div class="info text-center mt-4 mb-6 space-y-4">
      <div id="resultInfo" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      <div id="processingInfo" class="text-sm text-gray-400"></div>
    </div>
    
    <div class="bg-gray-700 rounded-xl p-4 overflow-hidden">
      <div class="flex items-center justify-center h-full w-full bg-gray-600 rounded-lg p-4">
        <canvas id="canvas" class="rounded-lg shadow-inner max-w-full h-auto"></canvas>
      </div>
    </div>
  </div>

  <script>
    // Constants for DOM elements
    const upload = document.getElementById('upload');
    const fileDropArea = document.getElementById('file-drop-area');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resizeMode = document.getElementById('resizeMode');
    const scaleBox = document.getElementById('scaleBox');
    const pixelBox = document.getElementById('pixelBox');
    const dpiBox = document.getElementById('dpiBox');
    const format = document.getElementById('format');
    const maxSize = document.getElementById('maxSize');
    const processBtn = document.getElementById('processBtn');
    const downloadLink = document.getElementById('download');
    const resultInfo = document.getElementById('resultInfo');
    const processingInfo = document.getElementById('processingInfo');

    let img = new Image();
    let originalFileName = '';
    let originalFileSize = 0;

    // Helper function to handle file loading
    const handleFile = (file) => {
      if (!file || !file.type.startsWith('image/')) {
        processingInfo.innerHTML = '<span class="text-red-400 font-semibold">Please upload a valid image file.</span>';
        downloadLink.classList.add('hidden');
        return;
      }
      
      originalFileName = file.name;
      originalFileSize = file.size;

      const reader = new FileReader();
      reader.onload = evt => {
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          updateResultDisplay();
          downloadLink.classList.add('hidden');
        };
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    };

    // Add drag-and-drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      fileDropArea.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
      }, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
      fileDropArea.addEventListener(eventName, () => {
        fileDropArea.classList.add('bg-gray-600', 'border-blue-400');
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      fileDropArea.addEventListener(eventName, () => {
        fileDropArea.classList.remove('bg-gray-600', 'border-blue-400');
      }, false);
    });

    fileDropArea.addEventListener('drop', e => {
      const file = e.dataTransfer.files[0];
      handleFile(file);
    }, false);

    // Event listener for file upload via click
    upload.addEventListener('change', e => {
      const file = e.target.files[0];
      handleFile(file);
    });

    // Event listener to show/hide input boxes based on resize mode
    resizeMode.addEventListener('change', () => {
      scaleBox.classList.add('hidden');
      pixelBox.classList.add('hidden');
      dpiBox.classList.add('hidden');
      
      if (resizeMode.value === 'scale') {
        scaleBox.classList.remove('hidden');
      } else if (resizeMode.value === 'pixels') {
        pixelBox.classList.remove('hidden');
      } else if (resizeMode.value === 'dpi') {
        dpiBox.classList.remove('hidden');
      }
    });

    // Function to compress the image blob to the target size range
    async function compressToMaxSize(canvas, outputFormat, maxKB) {
      if (outputFormat === 'image/png') {
        // PNG doesn't support quality, so we can't force a size
        return new Promise(r => canvas.toBlob(r, outputFormat));
      }
      
      const minKB = Math.max(0, maxKB - 10);
      let quality = 0.1; // Start with a very low quality
      let blob = null;
      let lastBlob = null;
      
      // Iteratively increase quality with small steps to find the optimal size
      while (quality <= 1.0) {
        blob = await new Promise(r => canvas.toBlob(r, outputFormat, quality));
        const sizeKB = blob.size / 1024;

        if (sizeKB > maxKB) {
          // If we've overshot the max size, return the previous blob
          return lastBlob || blob;
        }

        if (sizeKB >= minKB) {
          // If we're within the desired range, return this blob
          return blob;
        }
        
        lastBlob = blob;
        quality += 0.01; // Tiny step for precision
      }
      
      // Fallback if the loop completes (shouldn't happen)
      return blob;
    }

    // Function to update the results display
    const updateResultDisplay = (processedData = null) => {
      let originalHtml = `
        <div class="info-card p-4 rounded-xl border-2">
          <h3 class="font-bold text-lg mb-2 text-white">Original Image:</h3>
          <p><strong>Dimensions:</strong> <span class="text-blue-400">${img.width}x${img.height} px</span></p>
          <p><strong>Size:</strong> <span class="text-blue-400">${(originalFileSize / 1024).toFixed(2)} KB</span></p>
        </div>
      `;

      let processedHtml = '';
      if (processedData) {
        const { width, height, sizeKB } = processedData;
        const maxKB = parseInt(maxSize.value) || 300;
        const minKB = Math.max(0, maxKB - 10);
        let status = 'Within Range';
        let statusClass = 'text-green-400';
        let statusIcon = '✅';

        if (sizeKB > maxKB || sizeKB < minKB) {
          status = 'Outside Target Range';
          statusClass = 'text-red-400';
          statusIcon = '⚠️';
        }
        
        processedHtml = `
          <div class="info-card p-4 rounded-xl border-2">
            <h3 class="font-bold text-lg mb-2 text-white">Processed Image:</h3>
            <p><strong>Dimensions:</strong> <span class="text-blue-400">${width}x${height} px</span></p>
            <p><strong>Size:</strong> <span class="text-blue-400">${sizeKB} KB</span></p>
            <p><strong>Status:</strong> <span class="${statusClass}">${statusIcon} ${status}</span></p>
          </div>
        `;
      }
      
      resultInfo.innerHTML = originalHtml + processedHtml;
      processingInfo.textContent = '';
    };

    // Main function to process the image
    async function processImage() {
      if (!img.src) {
        processingInfo.innerHTML = '<span class="text-red-400 font-semibold">Please upload an image first.</span>';
        return;
      }
      
      // Show loading state
      processBtn.disabled = true;
      processBtn.innerHTML = `
        <div class="flex items-center justify-center">
          <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Processing...
        </div>
      `;
      processingInfo.innerHTML = '<span class="text-blue-400">Resizing and converting...</span>';

      let newWidth, newHeight;
      const cmToInch = 2.54;

      // Calculate new dimensions based on selected mode
      if (resizeMode.value === 'scale') {
        const scaleValue = document.getElementById('scale').value || 100;
        const scale = scaleValue / 100;
        newWidth = Math.round(img.width * scale);
        newHeight = Math.round(img.height * scale);
      } else if (resizeMode.value === 'pixels') {
        newWidth = document.getElementById('width').value || img.width;
        newHeight = document.getElementById('height').value || img.height;
      } else if (resizeMode.value === 'dpi') {
        const cmWidth = document.getElementById('cmWidth').value;
        const cmHeight = document.getElementById('cmHeight').value;
        const dpi = document.getElementById('dpi').value || 300;
        if (!cmWidth || !cmHeight) {
          processingInfo.innerHTML = '<span class="text-red-400 font-semibold">Please enter both width and height for DPI mode.</span>';
          processBtn.disabled = false;
          processBtn.innerHTML = 'Apply & Preview';
          return;
        }
        newWidth = Math.round(cmWidth * dpi / cmToInch);
        newHeight = Math.round(cmHeight * dpi / cmToInch);
      }
      
      // Validate dimensions
      if (newWidth <= 0 || newHeight <= 0) {
        processingInfo.innerHTML = '<span class="text-red-400 font-semibold">Dimensions must be greater than zero.</span>';
        processBtn.disabled = false;
        processBtn.innerHTML = 'Apply & Preview';
        return;
      }

      // Set canvas size and draw the resized image
      canvas.width = newWidth;
      canvas.height = newHeight;
      ctx.drawImage(img, 0, 0, newWidth, newHeight);

      const outputFormat = format.value;
      const maxKB = parseInt(maxSize.value) || 300;
      
      // Get the compressed image blob
      const blob = await compressToMaxSize(canvas, outputFormat, maxKB);
      const url = URL.createObjectURL(blob);
      
      // Update download link and button
      downloadLink.href = url;
      const fileExtension = outputFormat.split('/')[1];
      const fileName = originalFileName.substring(0, originalFileName.lastIndexOf('.')) || originalFileName;
      downloadLink.download = `${fileName}_resized_${newWidth}x${newHeight}.${fileExtension}`;
      downloadLink.classList.remove('hidden');

      // Update info text with processed data
      const finalSizeKB = (blob.size / 1024).toFixed(2);
      updateResultDisplay({
        width: newWidth,
        height: newHeight,
        sizeKB: finalSizeKB
      });
      
      // Reset button state
      processBtn.disabled = false;
      processBtn.innerHTML = `
        <div class="flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
          </svg>
          <span>Apply & Preview</span>
        </div>
      `;
    }
  </script>
</body>
</html>